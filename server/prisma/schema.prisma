datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  fullNameEn   String
  fullNameTa   String?
  fullNameHi   String?
  grade        String?
  role         String   @default("BRANCH_USER") // ADMIN, RO_MANAGER, SECTION_USER, BRANCH_USER
  photo        Photo?   @relation(fields: [photoId], references: [id])
  photoId      String?
  section      String?  // The specific section (e.g., "Accounts", "Planning", "IT", "HR")
  
  branch       Branch?  @relation("BranchMembers", fields: [branchId], references: [id])
  branchId     String?
  
  // Leadership roles
  isRegionHead     Boolean @default(false)
  isSecondLine     Boolean @default(false)
  headedBranch     Branch? @relation("BranchHead")
  secondLineBranch Branch? @relation("BranchSecondLine")

  departments      Department[] @relation("UserDepartments")
  managedDepartments Department[] @relation("DepartmentHeads")

  designation      Designation? @relation(fields: [designationId], references: [id])
  designationId    String?
  
  preparedNotes    OfficeNote[] @relation("NotePreparer")
  approvedNotes    OfficeNote[] @relation("NoteApprover")
  requests         BranchRequest[]
  comments         Comment[]
  actionPoints     ActionPoint[]
  postingHistory   PostingHistory[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("users")
}

model Committee {
  id        String    @id @default(uuid())
  nameEn    String
  code      String    @unique
  frequency String    @default("MONTHLY")
  meetings  Meeting[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("committees")
}

model Meeting {
  id           String        @id @default(uuid())
  committee    Committee     @relation(fields: [committeeId], references: [id])
  committeeId  String
  date         DateTime
  venue        String        @default("Conference Room")
  status       String        @default("DRAFT")
  minutesJson  String?
  actionPoints ActionPoint[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("meetings")
}

model ActionPoint {
  id               String   @id @default(uuid())
  meeting          Meeting  @relation(fields: [meetingId], references: [id])
  meetingId        String
  content          String
  dueDate          DateTime?
  status           String   @default("PENDING")
  assignedTo       User?    @relation(fields: [assignedToUserId], references: [id])
  assignedToUserId String?
  completionDate   DateTime?
  remarks          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("action_points")
}

model Branch {
  id                String   @id @default(uuid())
  sNo               Int?
  code              String   @unique
  officeId          Int?
  nameEn            String
  nameTa            String?
  nameHi            String?
  type              String
  openDate          String?
  district          String?
  populationGroup   String?
  riskCategory      String?
  riskEffectiveDate DateTime?
  specialStatus     String?
  ifsc              String?
  address           String?
  latitude          Float?
  longitude         Float?
  pincode           String?

  // Leadership
  headUser          User?    @relation("BranchHead", fields: [headUserId], references: [id])
  headUserId        String?  @unique
  secondLineUser    User?    @relation("BranchSecondLine", fields: [secondLineUserId], references: [id])
  secondLineUserId  String?  @unique

  users             User[]   @relation("BranchMembers")
  
  snapshots         Snapshot[]
  notices           Notice[]
  letters           Letter[]
  requests          BranchRequest[]
  stationeryMovements StationeryMovement[]
  recoveryActions     RecoveryAction[]
  auditObservations   AuditObservation[]
  regionalAssets      RegionalAsset[]
  history             BranchHistory[]
  postingHistory      PostingHistory[]

  @@map("branches")
}

model Department {
  id        String   @id @default(uuid())
  code      String   @unique
  nameEn    String
  nameTa    String?
  nameHi    String?
  users     User[]   @relation("UserDepartments")
  heads     User[]   @relation("DepartmentHeads")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("departments")
}

model Designation {
  id        String   @id @default(uuid())
  code      String   @unique
  nameEn    String
  nameTa    String?
  nameHi    String?
  workId    Int?
  users     User[]
  postingHistory PostingHistory[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("designations")
}

model BranchHistory {
  id           String   @id @default(uuid())
  branch       Branch   @relation(fields: [branchId], references: [id])
  branchId     String
  fieldChanged String
  oldValue     String?
  newValue     String?
  changedBy    String
  changedAt    DateTime @default(now())

  @@map("branch_history")
}

model Letter {
  id           String   @id @default(uuid())
  type         String
  status       String   @default("DRAFT")
  titleEn     String
  contentEn    String
  titleTa      String?
  contentTa    String?
  branch       Branch   @relation(fields: [branchId], references: [id])
  branchId     String
  parameter    Parameter? @relation(fields: [parameterId], references: [id])
  parameterId  String?
  valueAtTime  Float?
  budgetAtTime Float?
  period       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("letters")
}

model OfficeNote {
  id          String   @id @default(uuid())
  type        String
  status      String   @default("DRAFT")
  titleEn     String
  contentJson String
  preparer    User     @relation("NotePreparer", fields: [preparerId], references: [id])
  preparerId  String
  approver    User?    @relation("NoteApprover", fields: [approverId], references: [id])
  approverId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("office_notes")
}

model BranchRequest {
  id               String   @id @default(uuid())
  titleEn          String
  contentEn        String
  category         String
  status           String   @default("OPEN")
  priority         String   @default("MEDIUM")
  branch           Branch   @relation(fields: [branchId], references: [id])
  branchId         String
  user             User     @relation(fields: [userId], references: [id])
  userId           String
  assignedSection  String?
  resolutionNotes  String?
  comments         Comment[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("branch_requests")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  request   BranchRequest @relation(fields: [requestId], references: [id])
  requestId String
  createdAt DateTime @default(now())

  @@map("comments")
}

model Photo {
  id          String   @id @default(uuid())
  data        String
  checksum    String?
  aspectRatio String   @default("4:5")
  createdAt   DateTime @default(now())
  User        User[]

  @@map("photos")
}

model Holiday {
  id          String   @id @default(uuid())
  date        DateTime @unique
  nameEn      String
  nameTa      String?
  nameHi      String?
  type        String
  description String?
  createdAt   DateTime @default(now())

  @@map("holidays")
}

model Parameter {
  id          String   @id @default(uuid())
  code        String   @unique
  nameEn      String
  nameTa      String?
  nameHi      String?
  category    String
  unit        String   @default("Cr")
  snapshots   Snapshot[]
  letters     Letter[]

  @@map("parameters")
}

model Snapshot {
  id          String   @id @default(uuid())
  date        DateTime
  parameter   Parameter @relation(fields: [parameterId], references: [id])
  parameterId String
  branch      Branch?   @relation(fields: [branchId], references: [id])
  branchId    String?
  value       Float
  budget      Float?
  status      String?
  createdAt   DateTime @default(now())

  @@index([date])
  @@map("snapshots")
}

model Notice {
  id          String   @id @default(uuid())
  titleEn     String
  titleTa     String?
  contentEn   String
  contentTa   String?
  category    String
  priority    String   @default("NORMAL")
  isPinned    Boolean  @default(false)
  branch      Branch?  @relation(fields: [branchId], references: [id])
  branchId    String?
  targetRole  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notices")
}

model DispatchRecord {
  id            String   @id @default(uuid())
  type          String
  subject       String
  sender        String
  recipient     String
  referenceNo   String?
  consignmentNo String?
  status        String   @default("PENDING")
  date          DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("dispatch_records")
}

model StationeryItem {
  id         String               @id @default(uuid())
  nameEn     String               @unique
  stockLevel Int                  @default(0)
  movements  StationeryMovement[]
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@map("stationery_items")
}

model StationeryMovement {
  id        String         @id @default(uuid())
  item      StationeryItem @relation(fields: [itemId], references: [id])
  itemId    String
  branch    Branch?        @relation(fields: [branchId], references: [id])
  branchId  String?
  quantity  Int
  type      String
  date      DateTime       @default(now())
  remarks   String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@map("stationery_movements")
}

model Budget {
  id               String            @id @default(uuid())
  section          String
  financialYear    String
  allocationAmount Float
  spentAmount      Float             @default(0)
  sanctions        ExpenseSanction[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@unique([section, financialYear])
  @@map("budgets")
}

model ExpenseSanction {
  id           String   @id @default(uuid())
  title        String
  sanctionDate DateTime @default(now())
  amount       Float
  section      String
  vendorName   String?
  billNo       String?
  status       String   @default("APPROVED")
  type         String   @default("REVENUE")
  budget       Budget   @relation(fields: [budgetId], references: [id])
  budgetId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("expense_sanctions")
}

model LegalCase {
  id               String   @id @default(uuid())
  caseNo           String   @unique
  courtName        String
  parties          String
  nextHearingDate  DateTime?
  advocateName     String?
  status           String   @default("PENDING")
  category         String   @default("CIVIL")
  hearingHistory   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("legal_cases")
}

model RecoveryAction {
  id             String   @id @default(uuid())
  accountName    String
  amountInvolved Float
  type           String
  status         String   @default("NOTIFIED")
  branch         Branch   @relation(fields: [branchId], references: [id])
  branchId       String
  remarks        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("recovery_actions")
}

model AuditObservation {
  id                   String   @id @default(uuid())
  auditType            String
  observation          String
  riskLevel            String   @default("MEDIUM")
  status               String   @default("PENDING")
  rectificationDetails String?
  targetDate           DateTime
  auditDate            DateTime @default(now())
  branch               Branch   @relation(fields: [branchId], references: [id])
  branchId             String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("audit_observations")
}

model RegionalAsset {
  id                String              @id @default(uuid())
  assetCode         String              @unique
  category          String
  description       String
  purchaseDate      DateTime
  purchaseValue     Float
  condition         String              @default("GOOD")
  amcExpiry         DateTime?
  branch            Branch              @relation(fields: [branchId], references: [id])
  branchId          String
  maintenanceRecords MaintenanceRecord[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("regional_assets")
}

model MaintenanceRecord {
  id               String        @id @default(uuid())
  serviceDate      DateTime
  serviceProvider  String
  cost             Float
  remarks          String?
  nextServiceDue   DateTime
  asset            RegionalAsset @relation(fields: [assetId], references: [id])
  assetId          String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@map("maintenance_records")
}

model PostingHistory {
  id            String      @id @default(uuid())
  user          User        @relation(fields: [userId], references: [id])
  userId        String
  branch        Branch      @relation(fields: [branchId], references: [id])
  branchId      String
  designation   Designation? @relation(fields: [designationId], references: [id])
  designationId String?
  startDate     DateTime    @default(now())
  endDate       DateTime?
  isCurrent     Boolean     @default(true)
  remarks       String?
  createdAt     DateTime    @default(now())

  @@map("posting_history")
}